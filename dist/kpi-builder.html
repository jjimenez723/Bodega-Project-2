<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPI Builder | Rutgers Newark Bodega Project</title>
  <!-- Google Font & Core Site Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* KPI Builder specific tweaks */
    html,body{height:100%}
    body{display:flex;flex-direction:column}
    #hot{height:calc(100vh - 200px);width:100%} /* Dynamic height to show all rows */
    .offcanvas.draggable{transition:none!important}
    
    /* Ensure the table takes up available space */
    .container-fluid {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* Make the table container flexible */
    #hot {
      flex: 1;
      min-height: 400px;
    }
    
    /* Reduce spacing for more table space */
    .accordion {
      margin-top: 1rem !important;
    }
    
    .card.mt-3 {
      margin-top: 1rem !important;
    }
    
    /* Beautiful Role Toggle Styles */
    .role-selector-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 2rem 0;
      padding: 1rem;
    }
    
    .role-toggle-group {
      display: flex;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
    }
    
    .role-toggle {
      position: relative;
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 120px;
      text-align: center;
    }
    
    .role-toggle:hover {
      color: #015941;
      background: rgba(1, 89, 65, 0.1);
    }
    
    .role-toggle.active {
      background: #015941;
      color: white;
      box-shadow: 0 2px 8px rgba(1, 89, 65, 0.3);
    }
    
    .role-toggle.active:hover {
      background: #004684;
      transform: translateY(-1px);
    }
    
    /* Responsive design for role toggles */
    @media (max-width: 768px) {
      .role-toggle-group {
        flex-direction: column;
        gap: 4px;
        padding: 8px;
      }
      
      .role-toggle {
        min-width: 100px;
        padding: 10px 16px;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .role-toggle {
        min-width: 80px;
        padding: 8px 12px;
        font-size: 0.85rem;
      }
    }
    
    /* Offcanvas styles for column options */
    #columnOptions.offcanvas {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      width: 400px !important;
      height: 100vh !important;
      background: white !important;
      border-left: 1px solid #dee2e6 !important;
      box-shadow: -2px 0 8px rgba(0,0,0,0.1) !important;
      z-index: 1050 !important;
      transform: translateX(100%) !important;
      transition: transform 0.3s ease-in-out !important;
      visibility: visible !important;
      display: block !important;
    }
    
    #columnOptions.offcanvas.show {
      transform: translateX(0) !important;
    }
    
    /* Modern toggle slider styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-right: 10px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #015941;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    input:disabled + .toggle-slider {
      background-color: #e9ecef;
      cursor: not-allowed;
    }
    
    input:disabled:checked + .toggle-slider {
      background-color: #6c757d;
    }
    
    .toggle-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .toggle-item:last-child {
      border-bottom: none;
    }
    
    .toggle-label {
      flex: 1;
      font-size: 0.9rem;
      color: #333;
    }
    
    .toggle-label.disabled {
      color: #6c757d;
    }
    
    #columnOptions .offcanvas-header {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      padding: 1rem !important;
      border-bottom: 1px solid #dee2e6 !important;
    }
    
    #columnOptions .offcanvas-body {
      padding: 1rem !important;
      overflow-y: auto !important;
      height: calc(100vh - 80px) !important;
    }
    
    #columnOptions .offcanvas-title {
      margin: 0 !important;
      font-size: 1.1rem !important;
      font-weight: 600 !important;
    }
    
    #columnOptions .btn-close {
      background: none !important;
      border: none !important;
      font-size: 1.5rem !important;
      cursor: pointer !important;
      padding: 0 !important;
      width: 30px !important;
      height: 30px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    #columnOptions .btn-close:hover {
      background: #f8f9fa !important;
      border-radius: 4px !important;
    }
    
    /* Backdrop for offcanvas */
    .offcanvas-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 1040;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out;
    }
    
    .offcanvas-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* Prevent body scroll when offcanvas is open */
    body.offcanvas-open {
      overflow: hidden;
    }
    
    /* Responsive offcanvas for desktop */
    @media (min-width: 768px) {
      #columnOptions.offcanvas {
        width: 450px !important;
      }
    }
    
    @media (max-width: 767px) {
      #columnOptions.offcanvas {
        width: 100% !important;
      }
    }
  </style>
  <script type="module" crossorigin src="/assets/kpi-w66oS4Rt.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/enhancements-m85IZWfI.js">
  <link rel="stylesheet" crossorigin href="/assets/nav-mobile-Cd13IjyR.css">
</head>
<body>
  <!-- Header / Navigation -->
  <header class="sticky-header">
    <nav>
      <button class="hamburger" id="navToggle" aria-label="Open navigation" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
      <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="story.html">Story</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="./Map/map.html">Fast vs. Fresh Food Map</a></li>
        <li><a href="kpi-builder.html" class="active">KPI Builder</a></li>
        <li><a href="index.html#kpis">Data Visualization</a></li>
        <li><a href="index.html#team">Team</a></li>
      </ul>
    </nav>
    <div class="logo-bar">
      <img src="/assets/7-BxTG1g56.png" alt="NJ STEM Ecosystem Logo" />
      <img src="/assets/6-C_IZFNb7.png" alt="USDA Logo" />
      <img src="/assets/5-DZ5g2xn3.png" alt="Rutgers Logo" />
      <img src="/assets/4-DF4RMAYx.png" alt="BCC Logo" />
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>KPI Builder</h1>
      <p>Interactively model supply-chain margins across rolesâ€”from farm to distributor to bodega.</p>
    </div>
  </section>

  <!-- Main container for KPI Builder -->
  <div class="container-fluid mt-4 flex-grow-1 d-flex flex-column">
    <!-- Beautiful Role Toggle Selector -->
    <div class="role-selector-container">
      <div class="role-toggle-group">
        <button class="role-toggle" data-role="Farm" id="roleFarm">Farm</button>
        <button class="role-toggle" data-role="Distributor" id="roleDistributor">Distributor</button>
        <button class="role-toggle" data-role="Bodega" id="roleBodega">Bodega</button>
      </div>
      <button class="btn btn-outline-secondary ms-3" id="gearBtn" aria-label="Column options" style="border-radius: 8px; padding: 8px 12px;">&#9881;</button>
    </div>

    <!-- Handsontable Grid -->
    <div id="hot"></div>

    <!-- Totals Card -->
    <div class="card mt-3 d-none" id="totalsCard">
      <div class="card-body">
        <h5 class="card-title">Totals</h5>
        <div id="totalsContent" class="card-text"></div>
      </div>
    </div>

    <!-- Accordion -->
    <div class="accordion mt-4" id="definitionsAccordion">
      <!-- Column Definitions -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingCols">
          <button class="accordion-button collapsed" type="button">Column Definitions</button>
        </h2>
        <div class="accordion-collapse collapse" id="collapseCols">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr><th>Column name</th><th>What it captures</th></tr>
                </thead>
                <tbody>
                  <tr><td><strong>Produce</strong></td><td>The exact crop or item (acts as the unique key).</td></tr>
                  <tr><td><strong>Category</strong></td><td>Broad food group (<em>Fruit, Vegetable, Herb, etc.</em>) so the dashboard can apply group-level assumptions.</td></tr>
                  <tr><td><strong>Retail Price $/lb</strong></td><td>Shelf price shoppers pay per pound, taken from USDA-ERS national averages (editable).</td></tr>
                  <tr><td><strong>Retail Margin %</strong></td><td>Retailerâ€™s target gross-profit percentage on that item (default â‰ˆ 37 %).</td></tr>
                  <tr><td><strong>Retail Handling $/lb</strong></td><td>In-store labor, utilities, packaging, and other costs per pound (default $0.15 for fruit/veg, $0.50 for herbs).</td></tr>
                  <tr><td><strong>Bodega Shrink %</strong></td><td>Percent of product lost inside the store to spoilage or theft; model subtracts this before profit calc (defaults â‰ˆ 11â€“12 %).</td></tr>
                  <tr><td><strong>Farm Markup %</strong></td><td>Growerâ€™s desired markup added to production cost (default 15 %).</td></tr>
                  <tr><td><strong>Farm Cost $/lb</strong></td><td>Estimated cost for the farm to grow, harvest, cool, and pack one retail-ready pound.</td></tr>
                  <tr><td><strong>Farm Sale $/lb</strong></td><td>Actual price the farm receives: <code>Farm Cost Ã— (1 + Farm Markup %)</code>.</td></tr>
                  <tr><td><strong>Farm Shrink %</strong></td><td>Post-harvest loss before the load leaves the farm (default 2 %).</td></tr>
                  <tr><td><strong>Dist. Handling $/lb</strong></td><td>Cooling, storage, trucking, and admin cost for the distributor (default $0.22 fruit, $0.20 veg, $1.00 herbs).</td></tr>
                  <tr><td><strong>Dist. Margin %</strong></td><td>Distributorâ€™s target gross-profit percentage (default 12 %).</td></tr>
                  <tr><td><strong>Dist. Sale $/lb</strong></td><td>Price charged by the distributor: <code>(Farm Sale + Dist. Handling) Ã— (1 + Dist. Margin %)</code>.</td></tr>
                  <tr><td><strong>Dist. Shrink %</strong></td><td>Loss in the warehouse or during transit (default 4 %).</td></tr>
                  <tr><td><strong>Qty lbs</strong></td><td>Planned volume in pounds you expect to move for this item (user editable; powers the totals).</td></tr>
                  <tr><td><strong>Farm Gross Profit $/lb</strong></td><td>Extra cents the farm keeps on each pound after costs: <code>Farm Sale âˆ’ Farm Cost</code> (read-only).</td></tr>
                  <tr><td><strong>Farm Gross Margin %</strong></td><td>Farm gross profit expressed as a percent of Farm Sale price.</td></tr>
                  <tr><td><strong>Dist. Gross Profit $/lb</strong></td><td>Distributorâ€™s leftover cents per pound after paying the farm and its own handling cost.</td></tr>
                  <tr><td><strong>Dist. Gross Margin %</strong></td><td>Distributor gross profit as a percent of Dist. Sale price.</td></tr>
                  <tr><td><strong>Bodega Gross Profit $/lb</strong></td><td>Storeâ€™s leftover cents per pound after paying the distributor, subtracting shrink, and covering retail handling costs.</td></tr>
                  <tr><td><strong>Bodega Gross Margin %</strong></td><td>That gross profit written as a percent of the shelf price.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- KPI Definitions -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingKPIs">
          <button class="accordion-button collapsed" type="button">KPI Definitions</button>
        </h2>
        <div class="accordion-collapse collapse" id="collapseKPIs">
          <div class="accordion-body">
<div class="table-responsive">
  <table class="table table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>KPI</th>
        <th>Formula (column names)</th>
        <th>Why it matters &amp; how to read</th>
        <th>If the number looks <strong>too low</strong> â€¦</th>
        <th>If the number looks <strong>very high</strong> â€¦</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Farm&nbsp;Gross&nbsp;Profit&nbsp;per&nbsp;Pound</strong></td>
        <td><code>Farm Sale $/lb âˆ’ Farm Cost $/lb</code></td>
        <td>How many cents the farm retains on each pound after all growing, harvesting, cooling, and packing costs.</td>
        <td>
          Raise sale price to distributor; trim production costs (inputs, labor, packaging); improve yield to spread fixed costs.
        </td>
        <td>Consider reinvesting in quality upgrades or paying down debtâ€”avoid over-pricing the market.</td>
      </tr>
      <tr>
        <td><strong>Farm Gross Margin&nbsp;%</strong></td>
        <td><code>(Farm GP $/lb Ã· Farm Sale $/lb) Ã— 100</code></td>
        <td>Percentage profit. Many produce farms aim for <strong>15â€“25&nbsp;%</strong>.</td>
        <td>Same levers as above; also verify markup&nbsp;% is realistic.</td>
        <td>If above 30&nbsp;% for a staple crop you may risk losing buyers.</td>
      </tr>
      <tr>
        <td><strong>Distributor Gross Profit&nbsp;per&nbsp;Pound</strong></td>
        <td><code>Dist. Sale $/lb âˆ’ Farm Sale $/lb âˆ’ Dist. Handling $/lb</code></td>
        <td>Left-over cents for wholesaler after paying the farm and covering cooling, storage, trucking, and labor (goal&nbsp;8â€“15 Â¢).</td>
        <td>Negotiate lower farm price; raise distributor margin&nbsp;% ; cut fuel or warehouse costs.</td>
        <td>Use cushion to offer volume discounts or invest in better cold-chain equipment.</td>
      </tr>
      <tr>
        <td><strong>Distributor Gross Margin&nbsp;%</strong></td>
        <td><code>(Dist. GP $/lb Ã· Dist. Sale $/lb) Ã— 100</code></td>
        <td>Efficiency scoreâ€”most regional produce houses run <strong>10â€“15&nbsp;%</strong>.</td>
        <td>Below 8&nbsp;%: route may be unprofitableâ€”revisit prices or drop slow items.</td>
        <td>Over 18&nbsp;% could trigger retailer push-back; consider strategic discounts.</td>
      </tr>
      <tr>
        <td><strong>Bodega Gross Profit&nbsp;per&nbsp;Pound</strong></td>
        <td><code>(Retail Price $/lb Ã— (1 âˆ’ Bodega Shrink % /100)) âˆ’ Dist. Sale $/lb âˆ’ Retail Handling $/lb</code></td>
        <td>Storeâ€™s cents after paying distributor, factoring spoilage/theft, and in-store handling. Target <strong>35â€“45 Â¢</strong>.</td>
        <td>Raise shelf price; run promos to cut shrink; reduce handling costs.</td>
        <td>Leverage surplus for specials to draw traffic or upgrade displays.</td>
      </tr>
      <tr>
        <td><strong>Bodega Gross Margin&nbsp;%</strong></td>
        <td><code>(Bodega GP $/lb Ã· Retail Price $/lb) Ã— 100</code></td>
        <td>Percent margin. Supermarkets average ~<strong>37&nbsp;%</strong>.</td>
        <td>Below 25&nbsp;%: under-pricing or wasting too much.</td>
        <td>Above 45&nbsp;%: check competitiveness; shoppers may trade down.</td>
      </tr>
      <tr>
        <td><strong>Total Quantity&nbsp;(lbs)</strong></td>
        <td>Î£ Quantity lbs for visible rows</td>
        <td>Planned volume for selected crops.</td>
        <td>â€”</td>
        <td>â€”</td>
      </tr>
      <tr>
        <td><strong>Total Revenue&nbsp;($)</strong></td>
        <td>If Farm â†’ Î£(Farm Sale $/lb Ã— Qty) <br>Distributor â†’ Î£(Dist. Sale $/lb Ã— Qty) <br>Bodega â†’ Î£(Retail Price $/lb Ã— (1 âˆ’ Shrink&nbsp;%) Ã— Qty)</td>
        <td>Top-line sales dollars for chosen role, adjusted for shrink when viewing as Bodega.</td>
        <td>Increase quantity, price, or both; trim shrink (retail role).</td>
        <td>Check capacity (acreage, truck or shelf space) to handle volume.</td>
      </tr>
      <tr>
        <td><strong>Total Gross Profit&nbsp;($)</strong></td>
        <td>Role-specific GP per pound Ã— Qty, summed for visible rows</td>
        <td>Absolute earnings for the batch.</td>
        <td>Adjust per-pound GP levers starting with highest-volume items.</td>
        <td>Reinvest; ensure long-term demand isnâ€™t hurt.</td>
      </tr>
      <tr>
        <td><strong>Average Gross Margin&nbsp;%</strong></td>
        <td>(Total Gross Profit Ã· Total Revenue) Ã— 100</td>
        <td>Weighted margin across everything selectedâ€”big-picture health.</td>
        <td>Below benchmark: focus on low-margin items or renegotiate large contracts.</td>
        <td>Above benchmark: greatâ€”monitor competitor prices to stay sustainable.</td>
      </tr>
    </tbody>
  </table>
</div>
          </div>
        </div>
      </div>
      <!-- Citations -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingCite">
          <button class="accordion-button collapsed" type="button">Citations</button>
        </h2>
        <div class="accordion-collapse collapse" id="collapseCite">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Source description</th>
                    <th scope="col">Verified link</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th scope="row">1</th>
                    <td><strong>USDA ERS â€“ Fruit &amp; Vegetable Prices</strong> (interactive tables with national average retail prices per pound)</td>
                    <td><a href="https://www.ers.usda.gov/data-products/fruit-and-vegetable-prices" target="_blank" rel="noopener">View</a></td>
                  </tr>
                  <tr>
                    <th scope="row">2</th>
                    <td><strong>USDA ERS â€“ Price Spreads from Farm to Consumer</strong> (farm-share percentages for fresh fruits and vegetables)</td>
                    <td><a href="https://www.ers.usda.gov/data-products/price-spreads-from-farm-to-consumer" target="_blank" rel="noopener">View</a></td>
                  </tr>
                  <tr>
                    <th scope="row">3</th>
                    <td><strong>USDA ERS â€“ Food Dollar Series, 2023 Chart of Note</strong> (wholesale-trade share = 11.4 Â¢ of the food dollar)</td>
                    <td><a href="https://www.ers.usda.gov/data-products/charts-of-note/chart-detail?chartId=110567" target="_blank" rel="noopener">View</a></td>
                  </tr>
                  <tr>
                    <th scope="row">4</th>
                    <td><strong>USDA ERS â€“ Chart of Note: Supermarket shrink varies by type of fresh fruit and vegetable</strong> (shrink averages = 12.6 % fruit / 11.6 % veg)</td>
                    <td><a href="https://www.ers.usda.gov/data-products/charts-of-note/chart-detail?chartId=79033" target="_blank" rel="noopener">View</a></td>
                  </tr>
                  <tr>
                    <th scope="row">5</th>
                    <td><strong>USDA ERS â€“ Updated Supermarket Shrink Estimates for Fresh Foods</strong> (full methodology PDF, EIB-155)</td>
                    <td><a href="https://www.ers.usda.gov/sites/default/files/_laserfiche/publications/44100/EIB-155.pdf" target="_blank" rel="noopener">PDF</a></td>
                  </tr>
                  <tr>
                    <th scope="row">6</th>
                    <td><strong>International Fresh Produce Association â€“ Supermarket Produce Department Benchmarks (2024)</strong> (reports 37 % average produce gross margin)</td>
                    <td><a href="https://www.freshproduce.com/resources/retail/supermarket-produce-department-benchmarks/" target="_blank" rel="noopener">View</a></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Off-canvas (Column Options) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="columnOptions">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Column Options</h5>
      <button type="button" class="btn-close" id="closeCanvas" aria-label="Close">Ã—</button>
    </div>
    <div class="offcanvas-body">
      <h6 class="mb-2">Column Visibility</h6>
      <div id="columnToggles" class="mb-3"></div>
      <hr/>
      <h6 class="mb-2">Crop Filter</h6>
      <div id="cropToggles" style="max-height:200px;overflow:auto;"></div>
    </div>
  </div>
  
  <!-- Backdrop for offcanvas -->
  <div class="offcanvas-backdrop" id="offcanvasBackdrop"></div>

  <nav id="mobileNav" class="offcanvas" aria-label="Site">
    <a href="index.html">Home</a>
    <a href="story.html">Story</a>
    <a href="gallery.html">Gallery</a>
    <a href="./Map/map.html">Fast vs. Fresh Food Map</a>
    <a href="kpi-builder.html">KPI Builder</a>
    <a href="index.html#kpis">Data Visualization</a>
    <a href="index.html#team">Team</a>
  </nav>
  <div id="navOverlay" class="overlay" hidden></div>

  <!-- KPI Builder Script -->

  <!-- Site-wide JS (hamburger & misc) -->
</body>
</html> 
